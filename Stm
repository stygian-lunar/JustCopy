import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.util.*;
import java.util.stream.Collectors;

@Service
public class ItemValidator {

    @Value("${compare.map}")
    private String compareMapStr;

    @Value("${mandatory.keys}")
    private String mandatoryKeysStr;

    @Value("${allowed.instcodes}")
    private String allowedInstCodesStr;

    @Value("${external.api.url}")
    private String apiUrl;

    private final RestTemplate restTemplate = new RestTemplate();
    private final ObjectMapper objectMapper = new ObjectMapper();

    public boolean validateItem(Item item) {
        Map<String, String> compareMap = Arrays.stream(compareMapStr.split(","))
                .map(kv -> kv.split(":", 2))
                .filter(kv -> kv.length == 2)
                .collect(Collectors.toMap(kv -> kv[0].trim(), kv -> kv[1].trim()));

        List<String> mandatoryKeys = Arrays.stream(mandatoryKeysStr.split(","))
                .map(String::trim)
                .collect(Collectors.toList());

        List<String> allowedInstCodes = Arrays.stream(allowedInstCodesStr.split(","))
                .map(String::trim)
                .map(String::toUpperCase)
                .collect(Collectors.toList());

        return Optional.ofNullable(item)
                .filter(i -> allowedInstCodes.contains(
                        Optional.ofNullable(i.getInstCode()).orElse("").toUpperCase()))
                .map(Item::getTordval)
                .filter(tordval -> mandatoryKeys.stream()
                        .allMatch(k -> Optional.ofNullable(tordval.get(k))
                                .filter(v -> !v.isBlank()).isPresent()))
                .filter(tordval -> compareMap.entrySet().stream()
                        .allMatch(e -> e.getValue().equals(tordval.get(e.getKey()))))
                .map(tordval -> callApiAndCheckIndicator(item))
                .orElse(false);
    }

    private boolean callApiAndCheckIndicator(Item item) {
        try {
            String jsonResponse = restTemplate.postForObject(apiUrl, item, String.class);
            JsonNode jsonNode = objectMapper.readTree(jsonResponse);
            return jsonNode.path("indicator").asBoolean(false);
        } catch (Exception e) {
            // Optional: log the error
            return false;
        }
    }
}







public boolean validateItem(Order item) {
    return Optional.ofNullable(item)
            .filter(i -> {
                boolean allowed = config.getAllowedInstCodes().contains(i.getInstCode());
                LOGGER.info("Institution code check for '" + i.getInstCode() + "': " + allowed);
                return allowed;
            })
            .map(Order::getTordval)
            .filter(tordval -> {
                boolean allMatch = config.getCompareMap().entrySet().stream()
                        .allMatch(e -> {
                            String actual = tordval.get(e.getKey());
                            boolean match = e.getValue().equals(actual);
                            LOGGER.info("CompareMap Check - Key: '" + e.getKey() +
                                    "', Expected: '" + e.getValue() +
                                    "', Actual: '" + actual +
                                    "', Match: " + match);
                            return match;
                        });
                if (!allMatch) LOGGER.warning("CompareMap validation failed.");
                return allMatch;
            })
            .filter(tordval -> {
                boolean allPresent = config.getMandatoryKeys().stream()
                        .allMatch(k -> {
                            String val = tordval.get(k);
                            boolean valid = val != null && !val.isBlank();
                            LOGGER.info("Mandatory Field Check - Key: '" + k +
                                    "', Value: '" + val +
                                    "', Valid: " + valid);
                            return valid;
                        });
                if (!allPresent) LOGGER.warning("Mandatory key validation failed.");
                return allPresent;
            })
            .map(tordval -> {
                LOGGER.info("All checks passed. Calling API for final indicator check...");
                return callApiAndCheckIndicator(item);
            })
            .orElseGet(() -> {
                LOGGER.warning("Validation failed at one or more stages.");
                return false;
            });
}
